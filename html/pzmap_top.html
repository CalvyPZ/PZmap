

<!DOCTYPE html>
<html>
  <head>
    <title>PZ map (Top View)</title>
    <script type="text/javascript" src='openseadragon/openseadragon.js'></script>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body { height: 100%; margin: 0; padding: 0; background-color: white;}
      .legend { height: 1em; width: 1em; display: inline-block; border-color: #000; background-color:#fff; border-width: 1px; border-style: solid;}
    </style>
  </head>

  <body>
    <div style="display: flex; flex-flow: column; height: 100%;">
      <div style="flex: 0 1 auto;background-color:white;">
        <button type="button" onclick="toggleZombie()">Zombie</button>
        <button type="button" onclick="toggleGrid()">Grid</button>
        <button type="button" onclick="toggleForaging()">Foraging</button>
        <button type="button" onclick="setLayer(0)">Layer 0</button>
        <button type="button" onclick="setLayer(1)">Layer 1</button>
        <button type="button" onclick="setLayer(2)">Layer 2</button>
        <button type="button" onclick="setLayer(3)">Layer 3</button>
        <button type="button" onclick="setLayer(4)">Layer 4</button>
        <button type="button" onclick="setLayer(5)">Layer 5</button>
        <button type="button" onclick="setLayer(6)">Layer 6</button>
        <button type="button" onclick="setLayer(7)">Layer 7</button>
        Switch to <a href="pzmap.html">Isometric View</a>
        <div>
          <div id="foraging_legend"></div>
        </div>
      </div>
      <div style="flex: 1 1 auto;">
        <div id="contentDiv" allowfullscreen style="height: 100%"> </div>
      </div>
    </div>
    <script type="text/javascript" src='base_top/extra.js'></script>
    <script type="text/javascript">
        var foraginLegendHTML = `
            <div class="legend" style="background-color:#fff"></div>Road
            <div class="legend" style="background-color:#00f"></div>Urban Area
            <div class="legend" style="background-color:#0ff"></div>Trailer Park
            <div class="legend" style="background-color:#ff0"></div>Vegitation
            <div class="legend" style="background-color:#0f0"></div>Forest
            <div class="legend" style="background-color:#080"></div>Deep Forest
            <div class="legend" style="background-color:#f0f"></div>Farmland
            <div class="legend" style="background-color:#f00"></div>Farm
        `;

        var _viewer = OpenSeadragon({
            element: document.getElementById("contentDiv"),
            tileSources:  "base_top/layer0.dzi",
            homeFillsViewer: true,
            showZoomControl: true,
            constrainDuringPan: true,
            visibilityRatio: 0.5,
            prefixUrl: "openseadragon/images/",
            minZoomImageRatio: 0.5,
            maxZoomPixelRatio: 12
        });
        _viewer.drawer.context.imageSmoothingEnabled = false;
        document.body.style.backgroundColor = 'black';
        var tiles = [0, 0, 0, 0, 0, 0, 0]
        var foraging = 0
        var room = 0
        var grid = 0
        var zombie = 0
        var curLayers = 0

        function textSize(ctx, text) {
            let m = ctx.measureText('-01234,56789');
            let ascent = m.actualBoundingBoxAscent;
            let descent = m.actualBoundingBoxDescent;
            let width = ctx.measureText(text).width;
            return [width, ascent, descent];
        }
        function drawCoord(ctx, c00, step, yoffset) {
            let w = ctx.canvas.width;
            let h = ctx.canvas.height;
            let gx0 = -Math.floor(c00.x / step) - 1;
            let cx0 = c00.x + (gx0 * step);
            let gy0 = -Math.floor(c00.y / step) - 1;
            let cy0 = c00.y + (gy0 * step);
            let text = 0;
            let m = 0;
            for (let x = 0; x <= w / step + 1; x++) {
                for (let y = 0; y <= h / step + 1; y++) {
                    cx = cx0 + (x * step);
                    cy = cy0 + (y * step);
                    coordx = gx0 + x;
                    coordy = gy0 + y;
                    text = '' + coordx + ',' + coordy;
                    m = ctx.measureText(text);
                    ctx.fillText(text, cx + 2, cy + yoffset);
                }
            }
        }

        function drawGrid(ctx, c00, step, line_width) {
            ctx.lineWidth = line_width;
            let w = ctx.canvas.width;
            let h = ctx.canvas.height;
            let x1 = c00.x;
            let y1 = c00.y;
            ctx.beginPath();
            let offset = Math.floor(x1 / step) * step;
            x1 -= offset;
            while (x1 <= w) {
                ctx.moveTo(x1, 0);
                ctx.lineTo(x1, h);
                x1 += step;
            }
            offset = Math.floor(y1 / step) * step;
            y1 -= offset;
            while (y1 <= h) {
                ctx.moveTo(0, y1);
                ctx.lineTo(w, y1);
                y1 += step;
            }
            ctx.stroke();
        }

        _viewer.addHandler('update-viewport', function() {
            if (grid != 0) {
                let ctx = _viewer.drawer.context;
                let zm = _viewer.viewport.getZoom(true);
                zm = _viewer.viewport.viewportToImageZoom(zm);
                zm *= window.devicePixelRatio;
                let vp00 = _viewer.viewport.imageToViewportCoordinates(x0, y0);
                let c00 = _viewer.viewport.pixelFromPoint(vp00, true);
                c00.x *= window.devicePixelRatio;
                c00.y *= window.devicePixelRatio;

                let sqr = xstep[0]; // 1
                let step_cell = sqr * 300 * zm;
                let step_block = sqr * 10 * zm;

                let cell_font = '12pt bold monospace';
                let block_font = '12pt monospace';

                // cell
                ctx.font = cell_font;
                let [cell_width, cell_ascent, cell_descent] = textSize(ctx, '-00,-00');
                let yoffset = 4 + cell_ascent;
                if (step_cell >= cell_width + 8 && step_cell >= yoffset + cell_descent + 4) {
                    ctx.fillStyle = 'yellow';
                    drawCoord(ctx, c00, step_cell, yoffset);

                    // block
                    ctx.font = block_font;
                    let [width, ascent, descent] = textSize(ctx, '-0000,-0000');
                    yoffset += cell_descent + ascent + 4;

                    if (step_block >= width + 8 && step_block >= yoffset + descent + 4) {
                        ctx.strokeStyle = 'lime';
                        drawGrid(ctx, c00, step_block, 1);
                        ctx.fillStyle = 'lime';
                        drawCoord(ctx, c00, step_block, yoffset);
                    }
                    ctx.strokeStyle = 'yellow';
                    drawGrid(ctx, c00, step_cell, 3);
                } else {
                    ctx.strokeStyle = 'yellow';
                    drawGrid(ctx, c00, step_cell, 1);
                }
            }
        })

        function addLayer(layer) {
            curLayers++;
            var _viewer1 = _viewer.addTiledImage({
                tileSource: "base_top/layer" + curLayers + ".dzi",
                opacity: 1,
                success: function (obj) {
                    tiles[layer] = obj.item;
                },
            });
        }
        function removeLayer() {
            if (curLayers == 0) {
                return;
            }
            curLayers--;
            item = tiles[curLayers];
            _viewer.world.removeItem(item);
            tiles[curLayers] = 0;
        }
        function setLayer(l) {
            if (curLayers < l) {
                for (i = curLayers; i < l; i++) {
                    addLayer(i);
                }
            }
            if (curLayers > l) {
                for (i = curLayers; i > l; i--) {
                    removeLayer();
                }
            }
            if (foraging != 0) {
                toggleForaging();
                toggleForaging();
            }
            if (zombie != 0) {
                toggleZombie();
                toggleZombie();
            }
            if (grid != 0) {
                toggleGrid();
                toggleGrid();
            }
        }
        function toggleZombie() {
            if (zombie == 0) {
                var _viewer1 = _viewer.addTiledImage({
                    tileSource: "zombie_top/layer0.dzi",
                    opacity: 1,
                    x: 0,
                    y: 0,
                    success: function (obj) {
                        zombie = obj.item;
                    },
                });
            } else {
                _viewer.world.removeItem(zombie);
                zombie = 0;
            }
        }
        function toggleGrid() {
            if (grid == 0) {
                grid = 1;
                _viewer.raiseEvent('update-viewport', {});
            } else {
                grid = 0;
                _viewer.forceRedraw();
            }
        }
        function toggleForaging() {
            if (foraging == 0) {
                var _viewer1 = _viewer.addTiledImage({
                    tileSource: "foraging_top/layer0.dzi",
                    opacity: 1,
                    x: 0,
                    y: 0,
                    success: function (obj) {
                        foraging = obj.item;
                    },
                });
                document.getElementById("foraging_legend").innerHTML = foraginLegendHTML;
            } else {
                _viewer.world.removeItem(foraging);
                foraging = 0;
                document.getElementById("foraging_legend").innerHTML = "";
            }
        }
    </script>
  </body>
</html>
